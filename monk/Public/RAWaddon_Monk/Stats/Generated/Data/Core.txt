new entry "Target_UnarmedAttack"
type "SpellData"
using "Target_UnarmedAttack"
data "SpellSuccess" "IF(not HasStatus('FANGS_OF_THE_FIRE_SNAKE',context.Source)):DealDamage(UnarmedDamage, Bludgeoning);IF(HasStatus('FANGS_OF_THE_FIRE_SNAKE',context.Source)):DealDamage(UnarmedDamage, Fire)"

// Step of the Wind. You can spend 1 ki point to take the Disengage or Dash action as a bonus action on your turn, and your jump distance is doubled for the turn.
new entry "Shout_Dash_StepOfTheWind"
type "SpellData"
using "Shout_Dash_StepOfTheWind"
data "Description" "7bff034e-35d6-47e9-aece-3c2bdb9fcd31;8"

new entry "Shout_Disengage_StepOfTheWind"
type "SpellData"
using "Shout_Disengage_StepOfTheWind"
data "Description" "65031a0a-f3af-428e-8bcd-d041f87c7363;2"

new entry "Shout_PatientDefense"
type "SpellData"
using "Shout_PatientDefense"
data "Description" "a4d2f511-6f9c-4f92-9a27-963427d9a1d3;5"

// ModifyUseCosts is only relevant if RAW default actions and RAW addon Jump are disabled
new entry "STEP_OF_THE_WIND"
type "StatusData"
using "STEP_OF_THE_WIND"
data "Boosts" "JumpMaxDistanceMultiplier(2);UnlockSpellVariant(SpellId('Projectile_Jump'),ModifyUseCosts(Replace,BonusActionPoint,0,0,BonusActionPoint))"

// Immobilized removes Dodge status
// Clean featsextra data as it overlaps with RAW (just visually through)
new entry "DODGE"
type "StatusData"
using "DODGE"
data "Description" "068aecf0-a0cf-4f96-89f7-01e660505685;1"
data "RemoveConditions" "HasStatus('SG_Incapacitated') or Immobilized()"
data "SoundLoop" ""
data "SoundStop" ""
data "StatusEffect" ""

// Returning a deflected missile works only if range is less or equal than 18
// If range is superior than 9, attack will have a disadavantage
new entry "Interrupt_DeflectMissiles"
type "InterruptData"
using "Interrupt_DeflectMissiles"
data "Description" "dd31966a-da1e-40dc-a142-28e6ae45902e;2"

new entry "DeflectMissiles"
type "PassiveData"
using "DeflectMissiles"
data "Boosts" "IF(not HasStatus('SG_Polymorph_BeastShape')):UnlockInterrupt(Interrupt_DeflectMissiles);UnlockInterrupt(Interrupt_DeflectMissiles_Return);UnlockInterrupt(Interrupt_DeflectMissiles_Return_Disadvantage)"

new entry "Interrupt_DeflectMissiles_Return"
type "InterruptData"
using "Interrupt_DeflectMissiles_Return"
data "DisplayName" "a932bee8-bf43-4fa7-bd2e-49554cb6aed3;1"
data "Description" "4bd989ec-ac4e-4c86-81f0-ce21a716945d;2"
data "DescriptionParams" "Distance(6)"
data "Conditions" "DistanceToTargetLesserOrEqualThan(6) and IsAbleToReact(context.Observer) and Self(context.Target,context.Observer) and IsAttackType(AttackType.RangedWeaponAttack) and not (IsCriticalMiss() or IsMiss()) and HasActionResource('DeflectMissiles_Charge', 1, 0, false, false, context.Observer) and not AnyEntityIsItem()"
data "Properties" "UseSpell(SWAP,Projectile_Deflect_Missiles,true,true,true,c4598bdb-fc07-40dd-a62c-90cc138bd76f);UseActionResource(OBSERVER_OBSERVER,DeflectMissiles_Charge,1,0)"

new entry "Projectile_Deflect_Missiles"
type "SpellData"
using "Projectile_Deflect_Missiles"
data "SpellSuccess" "IF(not HasStatus('FANGS_OF_THE_FIRE_SNAKE',context.Source)):DealDamage(UnarmedDamage, Bludgeoning);IF(HasStatus('FANGS_OF_THE_FIRE_SNAKE',context.Source)):DealDamage(UnarmedDamage, Fire)"
data "Description" "4bd989ec-ac4e-4c86-81f0-ce21a716945d;2"
data "DescriptionParams" "Distance(6)"
data "TargetRadius" "6"

new entry "Interrupt_DeflectMissiles_Return_Disadvantage"
type "InterruptData"
using "Interrupt_DeflectMissiles_Return"
data "DisplayName" "23d44242-1d68-483f-a91b-c22f19dd2db5;1"
data "Description" "2c036a3d-4a50-4f5a-95a3-d295ce610472;2"
data "DescriptionParams" "Distance(18);Distance(6)"
data "Conditions" "DistanceToTargetBetween(6, 18) and IsAbleToReact(context.Observer) and Self(context.Target,context.Observer) and IsAttackType(AttackType.RangedWeaponAttack) and not (IsCriticalMiss() or IsMiss()) and HasActionResource('DeflectMissiles_Charge', 1, 0, false, false, context.Observer) and not AnyEntityIsItem()"
data "Properties" "UseSpell(SWAP,Projectile_Deflect_Missiles_Disadvantage,true,true,true,c4598bdb-fc07-40dd-a62c-90cc138bd76f);UseActionResource(OBSERVER_OBSERVER,DeflectMissiles_Charge,1,0)"

new entry "Projectile_Deflect_Missiles_Disadvantage"
type "SpellData"
using "Projectile_Deflect_Missiles"
data "Description" "2c036a3d-4a50-4f5a-95a3-d295ce610472;2"
data "DescriptionParams" "Distance(18);Distance(6)"
data "SpellRoll" "Attack(AttackType.MeleeUnarmedAttack,false,true)"

// Flurry of Blows. Immediately after you take the Attack action on your turn, you can spend 1 ki point to make two unarmed strikes as a bonus action.
new entry "MartialArts_BonusUnarmedStrike"
type "PassiveData"
data "DisplayName" "hfcdc92c3g5dbdg4b16gbf4cg245385dc6bf3;3"
data "Description" "h1a953609ga861g4e08ga260gd3341f5a963e;5"
data "DescriptionParams" "DealDamage(LevelMapValue(MartialArts), Bludgeoning)"
data "Icon" "PassiveFeature_MartialArts_BonusUnarmedStrike"
data "Properties" "Highlighted"
data "StatsFunctorContext" "OnAttack;OnCast"
data "Conditions" "IsMeleeAttack() and IsMonkWeaponAttack() and not SpellId('Target_UnarmedStrike_Monk') and not SpellId('Target_FlurryOfBlows_FirstAttack') and not SpellId('Target_FlurryOfBlows_LastAttack')"
data "StatsFunctors" "ApplyStatus(SELF,MARTIAL_ARTS_BONUS_UNARMED_STRIKE,100,1);ApplyStatus(SELF,MARTIAL_ARTS_FLURRY_OF_BLOWS,100,1)"

new entry "Target_UnarmedStrike_Monk"
type "SpellData"
using "Target_UnarmedStrike_Monk"
data "SpellProperties" "IF(not Player(context.Source)):ApplyStatus(SELF,AI_HELPER_EXTRAATTACK,100,1);RemoveStatus(SELF,MARTIAL_ARTS_BONUS_UNARMED_STRIKE);RemoveStatus(SELF,MARTIAL_ARTS_FLURRY_OF_BLOWS)"
data "SpellSuccess" "IF(not HasStatus('FANGS_OF_THE_FIRE_SNAKE',context.Source)):DealDamage(UnarmedDamage, Bludgeoning);IF(HasStatus('FANGS_OF_THE_FIRE_SNAKE',context.Source)):DealDamage(UnarmedDamage, Fire)"

new entry "MARTIAL_ARTS_BONUS_UNARMED_STRIKE"
type "StatusData"
using "MARTIAL_ARTS_BONUS_UNARMED_STRIKE"
data "Boosts" "IF(HasActionResource('BonusActionPoint',1,0,false,false,context.Source)):UnlockSpell(Target_UnarmedStrike_Monk)"

new entry "MARTIAL_ARTS_FLURRY_OF_BLOWS"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h8314a48ag5f5dg464agb684g792054ad643d;2"
data "Description" "h8ed549a4ga454g49b4gb319g7335ccf73b3a;6"
data "Icon" "Action_Monk_FlurryOfBlows"
data "StackId" "MARTIAL_ARTS_FLURRY_OF_BLOWS"
data "TickType" "StartTurn"
data "Boosts" "IF(HasActionResource('BonusActionPoint',1,0,false,false,context.Source) and HasActionResource('KiPoint',1,0,false,false,context.Source)):UnlockSpell(Target_FlurryOfBlows_FirstAttack)"
data "StatusPropertyFlags" "DisableOverhead;DisablePortraitIndicator;DisableCombatlog"

new entry "MARTIAL_ARTS_FLURRY_OF_BLOWS_LAST_ATTACK"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h8314a48ag5f5dg464agb684g792054ad643d;2"
data "Description" "81821ccc-074c-4184-a1a1-d3a9d165c1cc;6"
data "Icon" "Action_Monk_FlurryOfBlows"
data "StackId" "MARTIAL_ARTS_FLURRY_OF_BLOWS_LAST_ATTACK"
data "TickType" "StartTurn"
data "Boosts" "UnlockSpell(Target_FlurryOfBlows_LastAttack)"
data "StatusPropertyFlags" "DisableOverhead;DisablePortraitIndicator;DisableCombatlog"

new entry "Target_FlurryOfBlows_FirstAttack"
type "SpellData"
using "Target_FlurryOfBlows"
data "Description" "81821ccc-074c-4184-a1a1-d3a9d165c1cc;6"
data "SpellAnimation" "8b8bb757-21ce-4e02-a2f3-97d55cf2f90b,,;0579f797-dd8e-408d-b18d-01650f6041e2,,;69345989-e868-432e-9d8c-84f4bcf77494,,;5925204d-590c-4d7c-ac62-a51ba44d4589,,;7bb52cd4-0b1c-4926-9165-fa92b75876a3,,;,,;0b07883a-08b8-43b6-ac18-84dc9e84ff50,,;,,;,,"
data "SpellRoll" "Attack(AttackType.MeleeUnarmedAttack)"
data "SpellSuccess" "IF(not HasStatus('FANGS_OF_THE_FIRE_SNAKE',context.Source)):DealDamage(UnarmedDamage, Bludgeoning);IF(HasStatus('FANGS_OF_THE_FIRE_SNAKE',context.Source)):DealDamage(UnarmedDamage, Fire)"
data "TooltipDamageList" "DealDamage(MartialArtsUnarmedDamage, Bludgeoning)"
data "SpellFlags" "IsMelee;IsHarmful;Temporary;DisableBlood"
data "SpellProperties" "RemoveStatus(SELF,MARTIAL_ARTS_BONUS_UNARMED_STRIKE);RemoveStatus(SELF,MARTIAL_ARTS_FLURRY_OF_BLOWS);ApplyStatus(SELF,MARTIAL_ARTS_FLURRY_OF_BLOWS_LAST_ATTACK,100,1)"

new entry "Target_FlurryOfBlows_LastAttack"
type "SpellData"
using "Target_UnarmedStrike_Monk"
data "DisplayName" "h8314a48ag5f5dg464agb684g792054ad643d;2"
data "Description" "81821ccc-074c-4184-a1a1-d3a9d165c1cc;6"
data "Icon" "Action_Monk_FlurryOfBlows"
data "SpellProperties" "RemoveStatus(SELF,MARTIAL_ARTS_FLURRY_OF_BLOWS_LAST_ATTACK)"
data "UseCosts" ""

// Slowfall: reduce any falling damage you take by an amount equal to five times your monk level.
// You land prone unless you avoid taking damage from the fall.
new entry "SlowFall"
type "PassiveData"
using "SlowFall"
data "Description" "2e855c47-a1ef-4444-a028-fc3a1a6ef733;2"
data "EnabledConditions" ""
data "EnabledContext" ""

new entry "SLOWFALL_PASSIVE_TECHNICAL"
type "StatusData"
using "SLOWFALL_PASSIVE_TECHNICAL"
data "Description" "0dd60c74-b15d-4dcf-9884-2ec87dcc7691;2"
data "TickType" ""
data "Boosts" ""
data "RemoveConditions" ""
data "RemoveEvents" ""
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;IgnoreResting"
data "StatusGroups" "SG_RemoveOnRespec"
data "OnRemoveFunctors" ""

//FIXME: StatusImmunity should be conditional if damage taken is 0
new entry "SLOWFALL_TECHNICAL"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h617ec5edg40a2g4fefga310gdee969416e36;1"
data "Description" "0dd60c74-b15d-4dcf-9884-2ec87dcc7691;2"
data "Icon" "Spell_Transmutation_FeatherFall"
data "StackId" "SLOWFALL_TECHNICAL"
//data "Boosts" "DamageReduction(Bludgeoning,Flat,(ClassLevel(Monk)*5));StatusImmunity(SG_Prone)"
data "Boosts" "DamageReduction(Bludgeoning,Flat,(ClassLevel(Monk)*5))"
data "StatusPropertyFlags" "DisableOverhead;DisablePortraitIndicator;DisableCombatlog"
data "OnRemoveFunctors" "UseActionResource(ReactionActionPoint,1)"

//TODO: you gain the ability to move along vertical surfaces
new entry "UnarmoredMovement_DifficultTerrain"
type "PassiveData"
using "UnarmoredMovement_DifficultTerrain"
data "Description" "984d9c6f-f6be-4bc6-91af-317da55c5365;7"
data "Boosts" "StatusImmunity(DIFFICULT_TERRAIN_DEEPWATER);StatusImmunity(DIFFICULT_TERRAIN_MUD);StatusImmunity(DIFFICULT_TERRAIN_GREASE);StatusImmunity(PRONE_GREASE);StatusImmunity(PRONE_SEWER)"

// Stunning Strike
new entry "Target_StunningStrike"
type "SpellData"
using "Target_StunningStrike"
data "SpellSuccess" "IF(not SavingThrow(Ability.Constitution, WisdomSaveDC())):ApplyStatus(STUNNED,100,1);DealDamage(MainMeleeWeapon, MainMeleeWeaponDamageType); ExecuteWeaponFunctors(MainHand)"

new entry "Target_StunningStrike_Unarmed"
type "SpellData"
using "Target_StunningStrike_Unarmed"
data "SpellSuccess" "IF(not SavingThrow(Ability.Constitution, WisdomSaveDC())):ApplyStatus(STUNNED,100,1);DealDamage(UnarmedDamage, Bludgeoning)"

new entry "StunningStrike_Passive"
type "PassiveData"
data "DisplayName" "ha2b41647g8c02g47c6g9d70g3460189d287c;1"
data "Description" "9e696cef-b886-4c7b-9553-341facdc929b;1"
data "TooltipAttackSave" "MeleeWeaponAttack;Constitution"
data "TooltipUseCosts" "KiPoint:1"
data "Icon" "Action_Monk_StunningStrike"
data "Properties" "Highlighted;IsToggled;ToggledDefaultAddToHotbar"
data "Boosts" "UnlockInterrupt(Interrupt_StunningStrike)"

new entry "Interrupt_StunningStrike"
type "InterruptData"
data "InterruptContext" "OnCastHit"
data "InterruptContextScope" "Self"
data "InterruptDefaultValue" "Ask;Enabled"
data "Container" "YesNoDecision"
data "DisplayName" "ha2b41647g8c02g47c6g9d70g3460189d287c;1"
data "Description" "9e696cef-b886-4c7b-9553-341facdc929b;1"
data "Icon" "Action_Monk_StunningStrike"
data "Conditions" "not Item() and Self(context.Source,context.Observer) and not Self(context.Source,context.Target) and IsMeleeAttack() and not HasStatus('SG_Stunned',context.Target) and HasDamageEffectFlag(DamageFlags.Hit) and not IsKillingBlow()"
data "Properties" "ApplyStatus(STUNNING_STRIKE,100,1)"
data "Cost" "KiPoint:1"
data "EnableCondition" "not HasStatus('SG_Polymorph') or Tagged('MINDFLAYER') or HasStatus('SG_Disguise')"
data "EnableContext" "OnStatusApplied"

new entry "STUNNING_STRIKE"
type "StatusData"
data "StatusType" "BOOST"
data "StackId" "STUNNING_STRIKE"
data "DisplayName" "h9bb4ea57g5174g47d4g942ag4baa6e2a4c0c;1"
data "Icon" "Status_Stunned"
data "OnApplyFunctors" "IF(not SavingThrow(Ability.Constitution, WisdomSaveDC())):ApplyStatus(STUNNED,100,1)"
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator"

// Stillness Of Mind, you can use your action to end one effect on yourself that is causing you to be charmed or frightened.
// Autocast if charmed (which would prevent you from using it manually anyway)
// If frightened, you can stil cast it manually if you want to
new entry "StillnessOfMind"
type "PassiveData"
using "StillnessOfMind"
data "DisplayName" "b9839978-40c8-482f-993f-15454c1e3b07;2"
data "Description" "5d129e97-1e4b-44dd-a56a-3f3dd0aa65d4;3"
data "Conditions" "HasStatus('SG_Charmed', context.Source) and HasActionResource('ActionPoint', 1, 0, false, false, context.Source)"
data "StatsFunctors" "RemoveStatus(SG_Charmed);RemoveStatus(SG_Frightened);UseActionResource(SELF,ActionPoint,1,0);UseSpell(SELF,Shout_StillnessOfMind,true,true,true)"

new entry "Shout_StillnessOfMind"
type "SpellData"
using "Shout_StillnessOfMind"
data "Conditions" "HasStatus('SG_Charmed', context.Source) or HasStatus('SG_Frightened', context.Source)"
